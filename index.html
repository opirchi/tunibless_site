<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
Â  <title>Ø®Ø±ÙŠØ·Ø© Ø£Ù‚Ø§Ù„ÙŠÙ… ØªÙˆÙ†Ø³</title>
Â  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
Â  <style>
Â  Â  body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; flex-direction: column; overflow: hidden; background-color: #f0f0f0; }
Â  Â  #header { padding: 10px 15px; background: #fff; border-bottom: 1px solid #dadd; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; flex-shrink: 0; }
Â  Â  #toggle-legend-btn { display: none; padding: 5px 10px; font-size: 1.2rem; background: #f8f8f8; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; }
Â  Â  #header label { font-weight: bold; flex-shrink: 0; }
Â  Â  #region-filter { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; flex-grow: 1; min-width: 200px; }
Â  Â  .main-container { position: relative; flex-grow: 1; display: flex; overflow: hidden; }
Â  Â  #legend-container { width: 340px; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1001; overflow-y: auto; flex-shrink: 0; transition: margin-right 0.3s ease; padding-bottom:20px;}
Â  Â  #map-wrapper { flex-grow: 1; position: relative; }
Â  Â  #map { height: 100%; width: 100%; }
Â  Â  #loader { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1002; transform: translate(-50%, -50%); }
Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  Â  .legend-panel h4 { margin: 0; padding: 15px; text-align: center; background: #f9f9f9; border-bottom: 1px solid #eee; font-size: 18px; }
Â  Â  .legend-region { padding: 0 15px 15px; }
Â  Â  .legend-region h5 { margin: 15px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 16px; }
Â  Â  .legend-region h5 .region-icon { width: 20px; height: 20px; display: inline-block; margin-left: 8px; border-radius: 50%; border: 2px solid #555; }
Â  Â  .legend-panel ul { list-style: none; padding: 0; margin: 0; }
Â  Â  .legend-panel li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
Â  Â  .legend-panel li:hover { background-color: #f5f5f5; }
Â  Â  .legend-panel li:last-child { border-bottom: none; }
Â  Â  .legend-panel .gov-name { font-weight: 500; }
Â  Â  .legend-panel .coordinator-name { color: #555; font-size: 13px; }
Â  Â  .legend-panel .member-count { font-weight: bold; color: #007bff; margin-right: 8px; font-size: 13px; }
Â  Â  .reset-view-button { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; color: #333; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); cursor: pointer; font-size: 1.2rem; text-decoration: none; }
Â  Â  .reset-view-button:hover { background: #f4f4f4; }
Â  Â  .leaflet-tooltip { background: rgba(0,123,255,0.9) !important; color:#fff !important; font-size:14px; font-weight:bold; padding:6px 10px; border-radius:6px; }
Â  Â  @media (max-width: 768px) {
Â  Â  Â  #toggle-legend-btn { display: block; }
Â  Â  Â  #legend-container { position: absolute; height: 100%; margin-right: -340px; }
Â  Â  Â  #legend-container.visible { margin-right: 0; }
Â  Â  }
Â  </style>
</head>
<body>

<div id="header">
Â  <button id="toggle-legend-btn" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ù„ÙŠÙ„">â˜°</button>
Â  <div style="flex-basis:100%; display:flex; align-items:center; gap:10px;">
Â  Â  <img src="https://i.imgur.com/rvVqkm6.png" alt="Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©" style="width:50px; height:50px; border-radius:50%; border:2px solid #007bff;">
Â  Â  <span style="font-weight:bold; font-size:16px;">Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©: Ø³Ø¹Ø§Ø¯ Ø§Ù„Ø¨Ø´ </span>
Â  </div>
Â  <label for="region-filter">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…:</label>
Â  <select id="region-filter">
Â  Â  <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ…</option>
Â  </select>
</div>

<div class="main-container">
Â  <div id="legend-container"></div>
Â  <div id="map-wrapper">
Â  Â  <div id="map"></div>
Â  Â  <div id="loader"></div>
Â  Â  <a id="reset-view-btn" class="reset-view-button" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶">&#x21BA;</a>
Â  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
const loader = document.getElementById('loader');
const regionFilter = document.getElementById('region-filter');
const legendContainer = document.getElementById('legend-container');
const toggleButton = document.getElementById('toggle-legend-btn');
const map = L.map('map', { center: [34, 9.5], zoom: 7, zoomControl: false, attributionControl: false });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {}).addTo(map);

// =========================================================================
// ğŸ‡¹ğŸ‡³ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ† Ù„Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… (5 Ø£Ù‚Ø§Ù„ÙŠÙ…)
// =========================================================================
const regionData = {
Â  "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ": { coordinator_name: "ØµÙˆÙÙŠØ© Ø§Ù„Ø¬Ù„Ø§Ù„ÙŠ" },
Â  "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ": { coordinator_name: "Ù„ÙŠÙ„Ù‰ Ù…Ø±ÙˆØ§Ù†ÙŠ" },
Â  "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ": { coordinator_name: "Ø±ÙŠÙ… ÙØ±Ø­Ø§Øª" },
Â  "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ": { coordinator_name: "ÙˆØµØ§Ù„ ØªÙ„ÙŠÙ„ÙŠ" },
Â  "Ø§Ù„Ø¬Ù†ÙˆØ¨":Â  Â  Â  Â { coordinator_name: "ÙˆØ­ÙŠØ¯Ø© ÙƒÙˆØ§Ø´" }
};

// =========================================================================
// ğŸ›ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª (24 ÙˆÙ„Ø§ÙŠØ©) - ØªØ´Ù…Ù„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ØŒ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ØŒ ÙˆÙ…Ù†Ø³Ù‚ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø«)
// =========================================================================
const governorateData = {
Â  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠÂ 
Â  "Tunis": { members: 1748, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "ÙŠØ³Ø±Ù‰ Ù…Ø­Ù…Ø¯" },Â 
Â  "Ariana": { members: 1074, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‡Ø§Ø¯ÙŠ Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠ" },Â 
Â  "Ben Arous": { members: 1559, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù‡Ø§Ø¬Ø± Ø³Ø¹ÙŠØ¯" },Â 
Â  "Manouba": { members: 887, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø§Ø³Ø§Ù…Ø© Ø¹ÙŠØ§Ø±ÙŠ" },Â 
Â  "Nabel": { members: 1494, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø±ÙˆØ¶Ø© Ø¹ÙŠØ§Ø¯" },Â 
Â  "Zagouen": { members: 300, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø²ØºÙˆØ§Ù† (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†)" },Â 
Â  "Bizerte": { members: 1004, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù†Ø²Ø§Ø± Ø§Ù„Ù‡Ø°Ù„ÙŠ" },Â 

Â  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠÂ 
Â  "Beja": { members: 369, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "ÙŠØ§Ø³Ù…ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¯Ø¨" },Â 
Â  "Jandouba": { members: 646, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø¹Ù…Ø± Ù‡Ù…Ø§Ù…ÙŠ" },Â 
Â  "Le kef": { members: 831, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ø±ÙˆÙ‰ Ù†ÙˆØ§ØµØ±ÙŠØ©" },Â 
Â  "Siliana": { members: 234, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø³Ù„ÙŠÙ… Ø§Ù„Ø±ÙŠØ§Ø­ÙŠ" },Â 
Â Â 
Â  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠÂ 
Â  "Sousse": { members: 1376, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ø­Ù…Ø¯ Ù…Ù‚Ø¯Ø§Ø¯" },Â 
Â  "Monastir": { members: 1091, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø¯Ø±ØµØ§Ù Ù†Ø§ÙŠÙ„ÙŠ" },Â 
Â  "Mahdia": { members: 746, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø²ÙŠØ§Ø¯ Ø¨ÙˆØ¯ÙŠØ©" },Â 
Â  "Sfax": { members: 1461, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø¹Ù…Ø§Ø¯ Ø¹Ù…Ø§Ø±" },Â 

Â  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠÂ 
Â  "Kairouan": { members: 618, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ù‡ÙŠØ´Ø±ÙŠ" },Â 
Â  "kasserine": { members: 485, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø¥ÙŠØ§Ø¯ Ù…ÙŠØ³Ø§ÙˆÙŠ" },Â 
Â  "Sidi Bouzid": { members: 968, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø®ÙŠØ±Ø© Ø¹Ø§ÙÙŠ" },Â 
Â  "Gafsa": { members: 1447, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø­ÙŠØ¯Ø± Ø§Ù„Ù…Ø´ÙŠ" },Â 
Â Â 
Â  // Ø§Ù„Ø¬Ù†ÙˆØ¨Â 
Â  "Touzer": { members: 972, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ø£Ø­Ù…Ø¯ Ù…Ù‚Ø¯Ù…" },Â 
Â  "Kebili": { members: 802, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ø§ÙŠÙ…Ø§Ù† Ø´Ø¹Ø§Ø¹Ø©" },Â 
Â  "Gabes": { members: 3806, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ø£Ø³Ø§Ù…Ø© Ø¨Ù† Ø²ÙŠØ¯" },Â 
Â  "Mednine": { members: 2754, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø¬ÙŠ Ø¨Ø§Ù„Ø±Ø¬Ø¨" },Â 
Â  "Tataouine": { members: 883, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù†Ø¨ÙŠÙ„ Ø¨ÙˆØ³Ù†ÙŠÙ†Ø©" }Â 
};

// =========================================================================
// ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø§Ø³ØªÙ…Ø§Ø±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ÙƒÙ„ ÙˆÙ„Ø§ÙŠØ©
// =========================================================================
const formsLinks = {
Â  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ
Â  "Tunis": "https://docs.google.com/forms/d/e/1FAIpQLSdLp23YSS1HARjCq8DZL5AzNoxJ808lteqnuvfqA1IeoAghpw/viewform",
Â  "Ariana": "https://docs.google.com/forms/d/e/1FAIpQLSeIGzfgByZSGhInjFxcxslf5vyqScEaKQHm4VsXFtYv-miJCQ/viewform",
Â  "Ben Arous": "https://docs.google.com/forms/d/e/1FAIpQLSeLsolZbo5wQ-93bH3ffVphPx2KEIkboswDQ87v9MosOb5txA/viewform",
Â  "Manouba": "https://docs.google.com/forms/d/e/1FAIpQLSfbMUil_LlnE1xaYW3BKKmRtRJpc6k55ufx5aMGS9TNP7oclg/viewform",
Â  "Nabel": "https://docs.google.com/forms/d/e/1FAIpQLSekivAqyuE8Wb9Bf6IvDYfi7O-y159dpyXduTlmsDNI10AVtw/viewform",
Â  "Zagouen": "https://docs.google.com/forms/d/e/1FAIpQLSdHSr9wNzqhvfuTI3FD3OXT6XGRJ0h13DBHCxtxJ31vTY-pfA/viewform",
Â  "Bizerte": "https://sites.google.com/view/bizerte1/accueil",

Â  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ
Â  "Beja": "https://docs.google.com/forms/d/e/1FAIpQLScDsTtGJyP-ZstwxkztGMKgZGmDPMKeyWGR1KMxrSdr0e7QcA/viewform",
Â  "Jandouba": "https://docs.google.com/forms/d/e/1FAIpQLScgGlJwQAl7O7PinXf8pCupylVzWdP69f-bscQag7i0LlbVig/viewform",
Â  "Le kef": "https://docs.google.com/forms/d/e/1FAIpQLSescTjA_TZUB2T8upCt3bLbiqN-T9gmZwH5-cpgPfUmjou5sw/viewform",
Â  "Siliana": "https://docs.google.com/forms/d/e/1FAIpQLSdZ0eKwHOv-Mf07tugXwmt_vxPRvdx_ZJH8mWXJuF8bNiBDBQ/viewform",

Â  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ
Â  "Sousse": "https://docs.google.com/forms/d/e/1FAIpQLSe33qs8SD6ZDFNsNovYB1byXzPzap4u3WNxqQQi4Ca7EpixGg/viewform",
Â  "Monastir": "https://docs.google.com/forms/d/e/1FAIpQLSewTK4rBmqaQoI69Ja9vPLrkual0rcyILTgpg5rGJq5D6SfJg/viewform",
Â  "Mahdia": "https://docs.google.com/forms/d/e/1FAIpQLSd2e2LnvCp5PRsjWCk18SqxffASW25O9Fp9W20DPnPgMSqwGw/viewform",
Â  "Sfax": "https://docs.google.com/forms/d/e/1FAIpQLScilM_Tjq3-smIDbyxNfEiZnbbuDUK4ww92s8ju4VNkoUeC9w/viewform",

Â  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ
Â  "Kairouan": "https://docs.google.com/forms/d/e/1FAIpQLSd-j6GZFTt0bG_UPqGeHEPxMETFfyyXW3F9IQE17eDQFig8wA/viewform",
Â  "kasserine": "https://docs.google.com/forms/d/e/1FAIpQLSfc2HFx7o_jDx2aJ85tnWZcuVK-ylH2s24qT2LCBbrVkBpv5A/viewform",
Â  "Sidi Bouzid": "https://docs.google.com/forms/d/e/1FAIpQLSfvWAc9xFU-YGRwEc9WPuBisUtKUnLwmM6MPw6mv1DzJYZecQ/viewform",
Â  "Gafsa": "https://docs.google.com/forms/d/e/1FAIpQLSdypdTUT8Bb7nLg8WVeJ8w030mbZJ8NCU3ltH4hC3YM19q3RA/viewform",

Â  // Ø§Ù„Ø¬Ù†ÙˆØ¨
Â  "Touzer": "https://docs.google.com/forms/d/e/1FAIpQLScYUXdyEDgy5LQjufhK7kamNV6HrwGN_tqvbszi1bpAE0r45Q/viewform",
Â  "Kebili": "https://docs.google.com/forms/d/e/1FAIpQLSds9-iNpbhZDDYvG-9dvN9LLeQcd3mN2s0sR3_bGblY3tjm9A/viewform",
Â  "Gabes": "https://docs.google.com/forms/d/e/1FAIpQLSeonk4YES79GrsuzczWTxp7NxBPinCiOdR5VpEPvXWpTEw8XA/viewform",
Â  "Mednine": "https://docs.google.com/forms/d/e/1FAIpQLScZNmOkZQIcFzop9XJTcgjueJAg2XqiDWD2O8Hk3n7F3MCG_Q/viewform",
Â  "Tataouine": "https://docs.google.com/forms/d/e/1FAIpQLScau2aVzneLDLv4atr0ouUvVx1vzC_A8z6DcAl1Gu43UXO0aQ/viewform"
};

const regionColors = { "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ": "#0096c7", "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ": "#52b69a", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ": "#f77f00", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ": "#ffe6a7", "Ø§Ù„Ø¬Ù†ÙˆØ¨": "#e63946" };

let geojsonLayer, lastSelectedLayer = null;
const regionBounds = {}, gouvFrToAr = {}, layersByGouvFr = {};

function style(feature) {
Â  const region = governorateData[feature.properties.gouv_fr]?.region;
Â  return { fillColor: regionColors[region] || '#cccccc', weight: 1.5, opacity: 1, color: 'white', fillOpacity: 0.85 };
}

function buildLegend() {
Â  let html = '<h4>Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… ÙˆØ§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ†</h4>';
Â  for (const regionName in regionData) {
Â  Â  const regionInfo = regionData[regionName];
Â  Â  html += `<div class="legend-region">
Â  Â  Â  <h5><span class="region-icon" style="background:${regionColors[regionName]}"></span>${regionName}</h5>
Â  Â  Â  <p><strong>Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ:</strong> ${regionInfo.coordinator_name}</p><ul>`;
Â  Â  for (const gouvFr in governorateData) {
Â  Â  Â  if (governorateData[gouvFr].region === regionName) {
Â  Â  Â  Â  const gouvData = governorateData[gouvFr];
Â  Â  Â  Â  const gouvAr = gouvFrToAr[gouvFr] || gouvFr;
Â  Â  Â  Â  const memberDisplay = gouvData.members>0 ? `<span class="member-count">(${gouvData.members.toLocaleString('ar')})</span>`:'';
Â  Â  Â  Â  html += `<li data-gouv-fr="${gouvFr}"><span class="gov-name">${gouvAr}</span><div>${memberDisplay}<span class="coordinator-name">${gouvData.coordinator_name}</span></div></li>`;
Â  Â  Â  }
Â  Â  }
Â  Â  html += `</ul></div>`;
Â  }
Â  legendContainer.innerHTML = html;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯
function highlightFeature(e) {
Â  const layer = e.target;
Â  const selectedRegion = regionFilter.value;
Â  const gouvNameFr = layer.feature.properties.gouv_fr;
Â  const data = governorateData[gouvNameFr];

Â  // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1: Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ… ØºÙŠØ± 'all' ÙˆØ§Ù„ÙˆÙ„Ø§ÙŠØ© Ù„Ø§ ØªÙ†ØªÙ…ÙŠ Ø¥Ù„ÙŠÙ‡
Â  if (selectedRegion !== 'all' && (!data || data.region !== selectedRegion)) {
Â  Â  return;
Â  }

Â  layer.setStyle({
Â  Â  weight: 3,
Â  Â  color: '#333',
Â  Â  fillOpacity: 1 
Â  });

Â  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
Â  Â  layer.bringToFront();
Â  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
function resetHighlight(e) {
Â  const layer = e.target;
Â  const selectedRegion = regionFilter.value;
Â  const gouvNameFr = layer.feature.properties.gouv_fr;
Â  const data = governorateData[gouvNameFr];

Â  let baseStyle = style(layer.feature);
Â Â 
Â  // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªÙ†ØªÙ…ÙŠ Ù„Ù„Ø¥Ù‚Ù„ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±
Â  if (selectedRegion !== 'all' && (!data || data.region !== selectedRegion)) {
Â  Â  baseStyle.fillOpacity = 0.1;
Â  } else {
Â  Â  baseStyle.fillOpacity = 0.85; // Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠØ¹ÙˆØ¯ Ù„Ø´ÙØ§ÙÙŠØªÙ‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
Â  }

Â  layer.setStyle(baseStyle);
}


// ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù GeoJSON Ù„Ø®Ø±ÙŠØ·Ø© ØªÙˆÙ†Ø³
fetch('TN-gouvernorats.geojson')
Â  .then(res=>res.json())
Â  .then(geojson=>{
Â  Â  const regions = new Set();
Â  Â  geojson.features.forEach(f=>{
Â  Â  Â  const gouvFr = f.properties.gouv_fr;
Â  Â  Â  gouvFrToAr[gouvFr] = f.properties.gouv_ar || gouvFr;
Â  Â  Â  layersByGouvFr[gouvFr] = null;
Â  Â  Â  const data = governorateData[gouvFr];
Â  Â  Â  if (data && data.region) { regions.add(data.region);Â 
Â  Â  Â  Â  const layerBounds = L.geoJSON(f).getBounds();
Â  Â  Â  Â  if (!regionBounds[data.region]) regionBounds[data.region]=layerBounds;Â 
Â  Â  Â  Â  else regionBounds[data.region].extend(layerBounds);
Â  Â  Â  }
Â  Â  });
Â  Â  regions.forEach(r => { const opt=document.createElement('option'); opt.value=r; opt.textContent=r; regionFilter.appendChild(opt); });

Â  Â  geojsonLayer = L.geoJSON(geojson, {
Â  Â  Â  style: style,
Â  Â  Â  onEachFeature: function(feature, layer) {
Â  Â  Â  Â  const gouvNameFr = feature.properties.gouv_fr;
Â  Â  Â  Â  layersByGouvFr[gouvNameFr] = layer;
Â  Â  Â  Â  const gouvData = governorateData[gouvNameFr];
Â  Â  Â  Â  const formUrl = formsLinks[gouvNameFr];

Â  Â  Â  Â  // 1. Ø±Ø¨Ø· Ø§Ù„Ù€ Tooltip (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨)
Â  Â  Â  Â  layer.bindTooltip(() => {
Â  Â  Â  Â  Â  if(!gouvData) return "";
Â  Â  Â  Â  Â  return `<strong>${gouvFrToAr[gouvNameFr]}</strong><br>Ø§Ù„Ù…Ù†Ø³Ù‚: ${gouvData.coordinator_name}<br>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${gouvData.members.toLocaleString('ar')}`;
Â  Â  Â  Â  }, { direction: 'top', sticky: true });

Â  Â  Â  Â  if (isTouchDevice) {
Â  Â  Â  Â  Â  // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù„ÙˆØ­ÙŠ/Ø§Ù„Ù‡Ø§ØªÙ: Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ØªØ¸Ù‡Ø± Ø§Ù„Ù€ PopupØŒ Ø§Ù„Ù€ Popup ÙÙŠÙ‡ Ø±Ø§Ø¨Ø·
Â  Â  Â  Â  Â  layer.on('click', e => {
Â  Â  Â  Â  Â  Â  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ highlight Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
Â  Â  Â  Â  Â  Â  if (lastSelectedLayer) geojsonLayer.resetStyle(lastSelectedLayer);
Â  Â  Â  Â  Â  Â  highlightFeature(e);
Â  Â  Â  Â  Â  Â  lastSelectedLayer = e.target;

                // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Popup Ù…ÙØªÙˆØ­ Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 2)
                map.closePopup();

Â  Â  Â  Â  Â  Â  // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ Popup
Â  Â  Â  Â  Â  Â  let popupText = `<h3 style="margin:0;">${gouvFrToAr[gouvNameFr]}</h3>`;
Â  Â  Â  Â  Â  Â  if (gouvData) {
Â  Â  Â  Â  Â  Â  Â  if (gouvData.members>0) popupText+=`<p style="margin: 5px 0;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${gouvData.members.toLocaleString('ar')}</p>`;
Â  Â  Â  Â  Â  Â  Â  if (gouvData.coordinator_name) popupText+=`<p style="margin: 5px 0;">Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ: ${gouvData.coordinator_name}</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (formUrl) popupText+=`<a href="${formUrl}" target="_blank" class="popup-link" style="display:block; padding:8px; background:#007bff; color:white; text-align:center; border-radius:4px; margin-top:10px; text-decoration:none;">ÙØªØ­ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  layer.bindPopup(popupText).openPopup();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨: Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙŠØ¸Ù‡Ø± TooltipØŒ ÙˆØ§Ù„Ù†Ù‚Ø± ÙŠÙ†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
Â  Â  Â  Â  Â  layer.on({
Â  Â  Â  Â  Â  Â  mouseover: highlightFeature,
Â  Â  Â  Â  Â  Â  mouseout: resetHighlight,
Â  Â  Â  Â  Â  Â  click: e=>{ if (formUrl) window.open(formUrl,'_blank'); } // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }).addTo(map);

Â  Â  map.fitBounds(geojsonLayer.getBounds().pad(0.05));
Â  Â  map.setMaxBounds(geojsonLayer.getBounds().pad(0.1));
Â  Â  buildLegend();

Â  Â  // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
Â  Â  legendContainer.querySelectorAll('li[data-gouv-fr]').forEach(item=>{
Â  Â  Â  const gouvFr = item.dataset.gouvFr;
Â  Â  Â  const layer = layersByGouvFr[gouvFr];
Â  Â  Â  const formUrl = formsLinks[gouvFr];
Â  Â  Â  if (!layer) return;
Â  Â  Â  
Â  Â  Â  // Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± (Mouseover/Mouseout) ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ ÙˆØ§Ù„Ù‡Ø§ØªÙ
Â  Â  Â  item.addEventListener('mouseover', ()=>layer.fire('mouseover'));
Â  Â  Â  item.addEventListener('mouseout', ()=>layer.fire('mouseout'));

Â  Â  Â  item.addEventListener('click', ()=>{
Â  Â  Â  Â  if (isTouchDevice) {
Â  Â  Â  Â  Â  // Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 2): Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¸Ù‡Ø± popup Ø¢Ø®Ø±
Â  Â  Â  Â  Â  // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„ÙƒØŒ Ù†ÙƒØªÙÙŠ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± (Highlight) ÙˆÙ†ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
Â  Â  Â  Â  Â  if (formUrl) window.open(formUrl,'_blank');
Â  Â  Â  Â  } else if (formUrl) {
Â  Â  Â  Â  Â  // Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨: Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙŠÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
Â  Â  Â  Â  Â  window.open(formUrl,'_blank');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });

Â  Â  loader.style.display='none';
Â  });

// ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¹Ù„Ù‰ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ… Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
regionFilter.addEventListener('change', e=>{
Â  const selectedRegion = e.target.value;
Â  geojsonLayer.eachLayer(layer=>{
Â  Â  const gouvNameFr = layer.feature.properties.gouv_fr;
Â  Â  const data = governorateData[gouvNameFr];
Â  Â  Â Â 
Â  Â  if (!data) return;

Â  Â  let newStyle = style(layer.feature);
Â  Â Â 
Â  Â  if (selectedRegion === 'all' || data.region === selectedRegion) {
Â  Â  Â  newStyle.fillOpacity = 0.85; // Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ø±Ø¦ÙŠØ© Ø¨ÙˆØ¶ÙˆØ­
Â  Â  } else {
Â  Â  Â  newStyle.fillOpacity = 0.1; // Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø´ÙØ§ÙØ© Ø¬Ø¯Ø§Ù‹ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1)
Â  Â  }
Â  Â Â 
Â  Â  layer.setStyle(newStyle);
Â  });
});

toggleButton.addEventListener('click', ()=>legendContainer.classList.toggle('visible'));
document.getElementById('reset-view-btn').addEventListener('click', ()=>{
Â  regionFilter.value='all';
Â  regionFilter.dispatchEvent(new Event('change'));
});
</script>
</body>
</html>
