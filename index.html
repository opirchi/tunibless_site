<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø£Ù‚Ø§Ù„ÙŠÙ… ØªÙˆÙ†Ø³</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; flex-direction: column; overflow: hidden; background-color: #f0f0f0; }
    #header { padding: 10px 15px; background: #fff; border-bottom: 1px solid #dadd; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; flex-shrink: 0; }
    #toggle-legend-btn { display: none; padding: 5px 10px; font-size: 1.2rem; background: #f8f8f8; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; }
    #header label { font-weight: bold; flex-shrink: 0; }
    #region-filter { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; flex-grow: 1; min-width: 200px; }
    .main-container { position: relative; flex-grow: 1; display: flex; overflow: hidden; }
    #legend-container { width: 340px; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1001; overflow-y: auto; flex-shrink: 0; transition: margin-right 0.3s ease; padding-bottom:20px;}
    #map-wrapper { flex-grow: 1; position: relative; }
    #map { height: 100%; width: 100%; }
    #loader { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1002; transform: translate(-50%, -50%); }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .legend-panel h4 { margin: 0; padding: 15px; text-align: center; background: #f9f9f9; border-bottom: 1px solid #eee; font-size: 18px; }
    .legend-region { padding: 0 15px 15px; }
    .legend-region h5 { margin: 15px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 16px; }
    .legend-region h5 .region-icon { width: 20px; height: 20px; display: inline-block; margin-left: 8px; border-radius: 50%; border: 2px solid #555; }
    .legend-panel ul { list-style: none; padding: 0; margin: 0; }
    .legend-panel li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
    .legend-panel li:hover { background-color: #f5f5f5; }
    .legend-panel li:last-child { border-bottom: none; }
    .legend-panel .gov-name { font-weight: 500; }
    .legend-panel .coordinator-name { color: #555; font-size: 13px; }
    .legend-panel .member-count { font-weight: bold; color: #007bff; margin-right: 8px; font-size: 13px; }
    .reset-view-button { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; color: #333; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); cursor: pointer; font-size: 1.2rem; text-decoration: none; }
    .reset-view-button:hover { background: #f4f4f4; }
    .leaflet-tooltip { background: rgba(0,123,255,0.9) !important; color:#fff !important; font-size:14px; font-weight:bold; padding:6px 10px; border-radius:6px; }
    @media (max-width: 768px) {
      #toggle-legend-btn { display: block; }
      #legend-container { position: absolute; height: 100%; margin-right: -340px; }
      #legend-container.visible { margin-right: 0; }
    }
  </style>
</head>
<body>

<div id="header">
  <button id="toggle-legend-btn" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ù„ÙŠÙ„">â˜°</button>
  <div style="flex-basis:100%; display:flex; align-items:center; gap:10px;">
    <img src="https://i.imgur.com/rvVqkm6.png" alt="Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©" style="width:50px; height:50px; border-radius:50%; border:2px solid #007bff;">
    <span style="font-weight:bold; font-size:16px;">Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©: Ø³Ø¹Ø§Ø¯ Ø§Ù„Ø¨Ø´ </span>
  </div>
  <label for="region-filter">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…:</label>
  <select id="region-filter">
    <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ…</option>
  </select>
</div>

<div class="main-container">
  <div id="legend-container"></div>
  <div id="map-wrapper">
    <div id="map"></div>
    <div id="loader"></div>
    <a id="reset-view-btn" class="reset-view-button" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶">&#x21BA;</a>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// =========================================================================
// Ø¥ØµÙ„Ø§Ø­ 1: ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
// =========================================================================
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
const loader = document.getElementById('loader');
const regionFilter = document.getElementById('region-filter');
const legendContainer = document.getElementById('legend-container');
const map = L.map('map', { center: [34, 9.5], zoom: 7, zoomControl: false, attributionControl: false });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {}).addTo(map);

// =========================================================================
// ğŸ‡¹ğŸ‡³ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ† Ù„Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… (5 Ø£Ù‚Ø§Ù„ÙŠÙ…) - (ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©)
// =========================================================================
const regionData = {
  "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ": { coordinator_name: "ØµÙˆÙÙŠØ© Ø§Ù„Ø¬Ù„Ø§Ù„ÙŠ" },
  "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ": { coordinator_name: "Ù„ÙŠÙ„Ù‰ Ù…Ø±ÙˆØ§Ù†ÙŠ" },
  "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ": { coordinator_name: "Ø±ÙŠÙ… ÙØ±Ø­Ø§Øª" },
  "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ": { coordinator_name: "ÙˆØµØ§Ù„ ØªÙ„ÙŠÙ„ÙŠ" },
  "Ø§Ù„Ø¬Ù†ÙˆØ¨":       { coordinator_name: "ÙˆØ­ÙŠØ¯Ø© ÙƒÙˆØ§Ø´" }
};

// =========================================================================
// ğŸ›ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª (24 ÙˆÙ„Ø§ÙŠØ©) - (ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©)
// (Ø¥ØµÙ„Ø§Ø­ 2): ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
// =========================================================================
const governorateData = {
  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ
  "Tunis": { members: 1748, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "ÙŠØ³Ø±Ù‰ Ù…Ø­Ù…Ø¯" },
  "Ariana": { members: 1074, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‡Ø§Ø¯ÙŠ Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠ" },
  "Ben Arous": { members: 1559, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù‡Ø§Ø¬Ø± Ø³Ø¹ÙŠØ¯" },
  "Manubah": { members: 887, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø§Ø³Ø§Ù…Ø© Ø¹ÙŠØ§Ø±ÙŠ" }, // 'Manouba' -> 'Manubah'
  "Nabeul": { members: 1494, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø±ÙˆØ¶Ø© Ø¹ÙŠØ§Ø¯" }, // 'Nabel' -> 'Nabeul'
  "Zaghouan": { members: 300, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø²ØºÙˆØ§Ù† (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†)" },
  "Bizerte": { members: 1004, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù†Ø²Ø§Ø± Ø§Ù„Ù‡Ø°Ù„ÙŠ" },
  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ
  "BÃ©ja": { members: 369, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "ÙŠØ§Ø³Ù…ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¯Ø¨" }, // 'Beja' -> 'BÃ©ja'
  "Jendouba": { members: 646, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø¹Ù…Ø± Ù‡Ù…Ø§Ù…ÙŠ" },
  "Le Kef": { members: 831, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ø±ÙˆÙ‰ Ù†ÙˆØ§ØµØ±ÙŠØ©" }, // 'Le kef' -> 'Le Kef'
  "Siliana": { members: 234, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø³Ù„ÙŠÙ… Ø§Ù„Ø±ÙŠØ§Ø­ÙŠ" },
  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ
  "Sousse": { members: 1376, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ø­Ù…Ø¯ Ù…Ù‚Ø¯Ø§Ø¯" },
  "Monastir": { members: 1091, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø¯Ø±ØµØ§Ù Ù†Ø§ÙŠÙ„ÙŠ" },
  "Mahdia": { members: 746, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø²ÙŠØ§Ø¯ Ø¨ÙˆØ¯ÙŠØ©" },
  "Sfax": { members: 1461, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø¹Ù…Ø§Ø¯ Ø¹Ù…Ø§Ø±" },
  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ
  "Kairouan": { members: 618, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ù‡ÙŠØ´Ø±ÙŠ" },
  "KassÃ©rine": { members: 485, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø¥ÙŠØ§Ø¯ Ù…ÙŠØ³Ø§ÙˆÙŠ" }, // 'kasserine' -> 'KassÃ©rine'
  "Sidi Bou Zid": { members: 968, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø®ÙŠØ±Ø© Ø¹Ø§ÙÙŠ" }, // 'Sidi Bouzid' -> 'Sidi Bou Zid'
  "Gafsa": { members: 1447, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ø­ÙŠØ¯Ø± Ø§Ù„Ù…Ø´ÙŠ" },
  // Ø§Ù„Ø¬Ù†ÙˆØ¨
  "Tozeur": { members: 972, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ø£Ø­Ù…Ø¯ Ù…Ù‚Ø¯Ù…" }, // 'Touzer' -> 'Tozeur'
  "Kebili": { members: 802, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ø§ÙŠÙ…Ø§Ù† Ø´Ø¹Ø§Ø¹Ø©" },
  "GabÃ¨s": { members: 3806, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ø£Ø³Ø§Ù…Ø© Ø¨Ù† Ø²ÙŠØ¯" }, // 'Gabes' -> 'GabÃ¨s'
  "MÃ©denine": { members: 2754, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø¬ÙŠ Ø¨Ø§Ù„Ø±Ø¬Ø¨" }, // 'Mednine' -> 'MÃ©denine'
  "Tataouine": { members: 883, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù†Ø¨ÙŠÙ„ Ø¨ÙˆØ³Ù†ÙŠÙ†Ø©" }
};

// =========================================================================
// ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø§Ø³ØªÙ…Ø§Ø±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - (ØªÙ… ØªÙ†Ø¸ÙŠÙÙ‡Ø§ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­)
// =========================================================================
const formsLinks = {
  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ
  "Tunis": "https://docs.google.com/forms/d/e/1FAIpQLSdLp23YSS1HARjCq8DZL5AzNoxJ808lteqnuvfqA1IeoAghpw/viewform",
  "Ariana": "https://docs.google.com/forms/d/e/1FAIpQLSeIGzfgByZSGhInjFxcxslf5vyqScEaKQHm4VsXFtYv-miJCQ/viewform",
  "Ben Arous": "https://docs.google.com/forms/d/e/1FAIpQLSeLsolZbo5wQ-93bH3ffVphPx2KEIkboswDQ87v9MosOb5txA/viewform",
  "Manubah": "https://docs.google.com/forms/d/e/1FAIpQLSfbMUil_LlnE1xaYW3BKKmRtRJpc6k55ufx5aMGS9TNP7oclg/viewform",
  "Nabeul": "https://docs.google.com/forms/d/e/1FAIpQLSekivAqyuE8Wb9Bf6IvDYfi7O-y159dpyXduTlmsDNI10AVtw/viewform",
  "Zaghouan": "https://docs.google.com/forms/d/e/1FAIpQLSdHSr9wNzqhvfuTI3FD3OXT6XGRJ0h13DBHCxtxJ31vTY-pfA/viewform",
  "Bizerte": "https://sites.google.com/view/bizerte1/accueil",
  // Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ
  "BÃ©ja": "https://docs.google.com/forms/d/e/1FAIpQLScDsTtGJyP-ZstwxkztGMKgZGmDPMKeyWGR1KMxrSdr0e7QcA/viewform",
  "Jendouba": "https://docs.google.com/forms/d/e/1FAIpQLScgGlJwQAl7O7PinXf8pCupylVzWdP69f-bscQag7i0LlbVig/viewform",
  "Le Kef": "https://docs.google.com/forms/d/e/1FAIpQLSescTjA_TZUB2T8upCt3bLbiqN-T9gmZwH5-cpgPfUmjou5sw/viewform",
  "Siliana": "https://docs.google.com/forms/d/e/1FAIpQLSdZ0eKwHOv-Mf07tugXwmt_vxPRvdx_ZJH8mWXJuF8bNiBDBQ/viewform",
  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ
  "Sousse": "https://docs.google.com/forms/d/e/1FAIpQLSe33qs8SD6ZDFNsNovYB1byXzPzap4u3WNxqQQi4Ca7EpixGg/viewform",
  "Monastir": "https://docs.google.com/forms/d/e/1FAIpQLSewTK4rBmqaQoI69Ja9vPLrkual0rcyILTgpg5rGJq5D6SfJg/viewform",
  "Mahdia": "https://docs.google.com/forms/d/e/1FAIpQLSd2e2LnvCp5PRsjWCk18SqxffASW25O9Fp9W20DPnPgMSqwGw/viewform",
  "Sfax": "https://docs.google.com/forms/d/e/1FAIpQLScilM_Tjq3-smIDbyxNfEiZnbbuDUK4ww92s8ju4VNkoUeC9w/viewform",
  // Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ
  "Kairouan": "https://docs.google.com/forms/d/e/1FAIpQLSd-j6GZFTt0bG_UPqGeHEPxMETFfyyXW3F9IQE17eDQFig8wA/viewform",
  "KassÃ©rine": "https://docs.google.com/forms/d/e/1FAIpQLSfc2HFx7o_jDx2aJ85tnWZcuVK-ylH2s24qT2LCBbrVkBpv5A/viewform",
  "Sidi Bou Zid": "https://docs.google.com/forms/d/e/1FAIpQLSfvWAc9xFU-YGRwEc9WPuBisUtKUnLwmM6MPw6mv1DzJYZecQ/viewform",
  "Gafsa": "https://docs.google.com/forms/d/e/1FAIpQLSdypdTUT8Bb7nLg8WVeJ8w030mbZJ8NCU3ltH4hC3YM19q3RA/viewform",
  // Ø§Ù„Ø¬Ù†ÙˆØ¨
  "Tozeur": "https://docs.google.com/forms/d/e/1FAIpQLScYUXdyEDgy5LQjufhK7kamNV6HrwGN_tqvbszi1bpAE0r45Q/viewform",
  "Kebili": "https://docs.google.com/forms/d/e/1FAIpQLSds9-iNpbhZDDYvG-9dvN9LLeQcd3mN2s0sR3_bGblY3tjm9A/viewform",
  "GabÃ¨s": "https://docs.google.com/forms/d/e/1FAIpQLSeonk4YES79GrsuzczWTxp7NxBPinCiOdR5VpEPvXWpTEw8XA/viewform",
  "MÃ©denine": "https://docs.google.com/forms/d/e/1FAIpQLScZNmOkZQIcFzop9XJTcgjueJAg2XqiDWD2O8Hk3n7F3MCG_Q/viewform",
  "Tataouine": "https://docs.google.com/forms/d/e/1FAIpQLScau2aVzneLDLv4atr0ouUvVx1vzC_A8z6DcAl1Gu43UXO0aQ/viewform"
};

const regionColors = { "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ": "#0096c7", "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ": "#52b69a", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ": "#f77f00", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ": "#ffe6a7", "Ø§Ù„Ø¬Ù†ÙˆØ¨": "#e63946" };

let geojsonLayer, lastSelectedLayer = null;
const regionBounds = {}, layersByGouvFr = {};

// (Ø¥ØµÙ„Ø§Ø­ 3): ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ù…Ù„Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
function style(feature) {
  // 'feature.properties.gouv_fr' -> 'feature.properties.shapeName'
  const region = governorateData[feature.properties.shapeName]?.region;
  return { fillColor: regionColors[region] || '#cccccc', weight: 1.5, opacity: 1, color: 'white', fillOpacity: 0.85 };
}

function buildLegend() {
  let html = '<h4>Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… ÙˆØ§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ†</h4>';
  for (const regionName in regionData) {
    const regionInfo = regionData[regionName];
    html += `<div class="legend-region">
      <h5><span class="region-icon" style="background:${regionColors[regionName]}"></span>${regionName}</h5>
      <p><strong>Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ:</strong> ${regionInfo.coordinator_name}</p><ul>`;
    for (const gouvFr in governorateData) {
      if (governorateData[gouvFr].region === regionName) {
        const gouvData = governorateData[gouvFr];
        const gouvAr = gouvFr; // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒÙ…ÙØªØ§Ø­
        const memberDisplay = gouvData.members>0 ? `<span class="member-count">(${gouvData.members.toLocaleString('ar')})</span>`:'';
        // Ù†Ø³ØªØ®Ø¯Ù… gouvFr (Ø§Ù„Ø°ÙŠ Ù‡Ùˆ Ø§Ù„Ø¢Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠ Ø§Ù„ØµØ­ÙŠØ­) ÙƒÙ…Ø¹Ø±Ù‘Ù
        html += `<li data-gouv-fr="${gouvFr}"><span class="gov-name">${gouvAr}</span><div>${memberDisplay}<span class="coordinator-name">${gouvData.coordinator_name}</span></div></li>`;
      }
    }
    html += `</ul></div>`;
  }
  legendContainer.innerHTML = html;
}

function highlightFeature(e) {
  const layer = e.target;
  const selectedRegion = regionFilter.value;
  const gouvNameFr = layer.feature.properties.shapeName; // Ø¥ØµÙ„Ø§Ø­
  const data = governorateData[gouvNameFr];

  if (selectedRegion !== 'all' && (!data || data.region !== selectedRegion)) {
    return;
  }
  layer.setStyle({ weight: 3, color: '#333', fillOpacity: 1 });
  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
    layer.bringToFront();
  }
}

function resetHighlight(e) {
  const layer = e.target;
  const selectedRegion = regionFilter.value;
  const gouvNameFr = layer.feature.properties.shapeName; // Ø¥ØµÙ„Ø§Ø­
  const data = governorateData[gouvNameFr];
  let baseStyle = style(layer.feature);
  
  if (selectedRegion !== 'all' && (!data || data.region !== selectedRegion)) {
    baseStyle.fillOpacity = 0.1;
  } else {
    baseStyle.fillOpacity = 0.85;
  }
  layer.setStyle(baseStyle);
}

// =========================================================================
// (Ø¥ØµÙ„Ø§Ø­ 4): ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
// =========================================================================
fetch('https://github.com/wmgeolab/geoBoundaries/raw/9469f09/releaseData/gbOpen/TUN/ADM1/geoBoundaries-TUN-ADM1.geojson')
  .then(res => res.json())
  .then(geojson => {
    const regions = new Set();
    geojson.features.forEach(f => {
      const gouvFr = f.properties.shapeName; // Ø¥ØµÙ„Ø§Ø­: gouv_fr -> shapeName
      // Ù„Ù… ÙŠØ¹Ø¯ gouv_ar Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠ ÙƒÙ…Ø¹Ø±Ù
      layersByGouvFr[gouvFr] = null;
      const data = governorateData[gouvFr];
      if (data && data.region) { 
        regions.add(data.region);
        const layerBounds = L.geoJSON(f).getBounds();
        if (!regionBounds[data.region]) regionBounds[data.region] = layerBounds;
        else regionBounds[data.region].extend(layerBounds);
      }
    });
    regions.forEach(r => { const opt=document.createElement('option'); opt.value=r; opt.textContent=r; regionFilter.appendChild(opt); });

    geojsonLayer = L.geoJSON(geojson, {
      style: style,
      onEachFeature: function(feature, layer) {
        const gouvNameFr = feature.properties.shapeName; // Ø¥ØµÙ„Ø§Ø­
        layersByGouvFr[gouvNameFr] = layer;
        const gouvData = governorateData[gouvNameFr];
        const formUrl = formsLinks[gouvNameFr];

        // 1. Tooltip
        layer.bindTooltip(() => {
          if(!gouvData) return "";
          // Ø¥ØµÙ„Ø§Ø­: gouvFrToAr[gouvNameFr] -> gouvNameFr
          return `<strong>${gouvNameFr}</strong><br>Ø§Ù„Ù…Ù†Ø³Ù‚: ${gouvData.coordinator_name}<br>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${gouvData.members.toLocaleString('ar')}`;
        }, { direction: 'top', sticky: true });

        if (isTouchDevice) {
          layer.on('click', e => {
            map.closePopup();
            if (lastSelectedLayer) geojsonLayer.resetStyle(lastSelectedLayer);
            highlightFeature(e);
            lastSelectedLayer = e.target;

            // Ø¥ØµÙ„Ø§Ø­: gouvFrToAr[gouvNameFr] -> gouvNameFr
            let popupText = `<h3 style="margin:0;">${gouvNameFr}</h3>`;
            if (gouvData) {
              if (gouvData.members > 0) {
                popupText += `<p style="margin: 5px 0;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${gouvData.members.toLocaleString('ar')}</p>`;
              }
              if (gouvData.coordinator_name) {
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ù…Øª Ø¨ØªØºÙŠÙŠØ± "Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ" Ø¥Ù„Ù‰ "Ù…Ù†Ø³Ù‚ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©" Ù„ØªÙƒÙˆÙ† Ø£ÙˆØ¶Ø­
                popupText += `<p style="margin: 5px 0;">Ù…Ù†Ø³Ù‚ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©: ${gouvData.coordinator_name}</p>`;
              }
            }
            if (formUrl) {
              popupText += `
                <a href="${formUrl}" target="_blank" class="popup-link"
                 style="display:block; padding:8px; background:#007bff; color:white; 
                 text-align:center; border-radius:4px; margin-top:10px; text-decoration:none;">
                 ÙØªØ­ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                </a>`;
            }
            if (!layer._popup) {
              layer.bindPopup(popupText, { autoPan: true });
            } else {
              layer._popup.setContent(popupText);
            }
            layer.openPopup();
          });
        } else {
          // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨
          layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: e => { if (formUrl) window.open(formUrl,'_blank'); }
          });
        }
      }
    }).addTo(map);

    map.fitBounds(geojsonLayer.getBounds().pad(0.05));
    map.setMaxBounds(geojsonLayer.getBounds().pad(0.1));
    buildLegend();

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    legendContainer.querySelectorAll('li[data-gouv-fr]').forEach(item => {
      const gouvFr = item.dataset.gouvFr;
      const layer = layersByGouvFr[gouvFr];
      const formUrl = formsLinks[gouvFr];
      if (!layer) return;
      item.addEventListener('mouseover', () => layer.fire('mouseover'));
      item.addEventListener('mouseout', () => layer.fire('mouseout'));
      item.addEventListener('click', () => {
        if (isTouchDevice) {
          layer.fire('click'); 
        } else if (formUrl) {
          window.open(formUrl,'_blank');
        }
      });
    });

    loader.style.display = 'none';
  }).catch(error => {
    // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§Ù†ØªØ±Ù†Øª)
    console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", error);
    loader.innerHTML = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
  });

// ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¹Ù„Ù‰ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…
regionFilter.addEventListener('change', e => {
  const selectedRegion = e.target.value;
  map.closePopup(); // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
  if(lastSelectedLayer) {
      geojsonLayer.resetStyle(lastSelectedLayer);
      lastSelectedLayer = null;
  }

  geojsonLayer.eachLayer(layer => {
    const gouvNameFr = layer.feature.properties.shapeName; // Ø¥ØµÙ„Ø§Ø­
    const data = governorateData[gouvNameFr];
    if (!data) return;
    let newStyle = style(layer.feature);
    if (selectedRegion === 'all' || data.region === selectedRegion) {
      newStyle.fillOpacity = 0.85;
    } else {
      newStyle.fillOpacity = 0.1;
    }
    layer.setStyle(newStyle);
  });
});

toggleButton.addEventListener('click', () => legendContainer.classList.toggle('visible'));
document.getElementById('reset-view-btn').addEventListener('click', () => {
  regionFilter.value = 'all';
  regionFilter.dispatchEvent(new Event('change'));
  map.fitBounds(geojsonLayer.getBounds().pad(0.05)); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
});
</script>
</body>
</html>
