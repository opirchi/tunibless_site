<div style="direction: rtl; font-family: system-ui, Tahoma, Arial; max-width: 500px; margin: 20px auto; text-align: center;">
  <h3>ูุญุต ุงูุชุฐุงูุฑ ุจุงูู QR</h3>
  <p>ุงุถุบุท ุนูู "ุจุฏุก ุงููุณุญ" ุซู ูุฌูู ุงููุงููุฑุง ุฅูู QR ูู ุงูุชุฐูุฑุฉ.</p>
  
  <button id="start-scan-btn" style="padding: 12px 25px; font-size: 16px; font-weight: bold; color: white; background-color: #007bff; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 15px;">
    ๐ท ุจุฏุก ุงููุณุญ
  </button>
  
  <div id="reader" style="width: 100%; border-radius: 8px; overflow: hidden;"></div>
  <div id="scan-msg" style="margin-top: 15px; font-weight: bold; font-size: 18px; padding: 10px; border-radius: 8px;"></div>
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
  // This listener ensures our code runs only after the page and libraries are ready.
  document.addEventListener('DOMContentLoaded', (event) => {
    
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyd2cG50qB9EWzHfZdki4-Op_XTA5kLXtWoV9rg9ld7ivy8VF7wE6Y9CoVHQ0OxCjyN/exec'; // <--- ุชุฃูุฏ ูู ูุถุน ุฑุงุจุท ุงูููุจ ุงูุตุญูุญ ููุง
    const msg = document.getElementById('scan-msg');
    const startBtn = document.getElementById('start-scan-btn');
    const readerDiv = document.getElementById('reader');

    const html5Qrcode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText, decodedResult) {
      html5Qrcode.stop().then(ignore => {
          msg.textContent = 'ุฌุงุฑู ุงูุชุญูู: ' + decodedText;
          msg.style.backgroundColor = '#eef2ff';
          msg.style.color = '#333';

          fetch(WEB_APP_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain'},
            body: JSON.stringify({ action: 'use', ticketId: decodedText })
          })
          .then(r => r.json())
          .then(j => {
            if (j.ok) {
              msg.textContent = 'โ ุชุฐูุฑุฉ ุตุงูุญุฉุ ุชู ุงูุฏุฎูู';
              msg.style.backgroundColor = '#dcfce7';
              msg.style.color = '#166534';
            } else {
              msg.textContent = 'โ ' + (j.error || 'ุชุฐูุฑุฉ ุบูุฑ ุตุงูุญุฉ');
              msg.style.backgroundColor = '#fee2e2';
              msg.style.color = '#991b1b';
            }
          })
          .catch(() => { 
              msg.textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู';
              msg.style.backgroundColor = '#fef3c7';
              msg.style.color = '#92400e';
          });
      }).catch(err => {
          console.error("ูุดู ุฅููุงู ุงููุณุญ.", err);
      });
    }

    function onScanFailure(error) {
      // We can ignore scan failures.
    }

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      msg.textContent = "ูุฑุฌู ููุญ ุงูุฅุฐู ูููุตูู ุฅูู ุงููุงููุฑุง...";
      msg.style.backgroundColor = 'transparent';
      msg.style.color = '#333';

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };
      
      html5Qrcode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
        .catch(err => {
          msg.textContent = "ุชุนุฐูุฑ ุชุดุบูู ุงููุงููุฑุง. ุชุฃูุฏ ูู ููุญ ุงูุฅุฐู ูุฃูู ุชุณุชุฎุฏู ุฑุงุจุท https.";
          msg.style.backgroundColor = '#fee2e2';
          msg.style.color = '#991b1b';
          startBtn.style.display = 'block';
        });
    });

  });
</script>
